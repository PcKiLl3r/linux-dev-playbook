---
- name: Install Bluetooth and audio packages
  ansible.builtin.package:
    name: "{{ bluetooth_packages }}"
    state: present
    use: "{{ pkg_mgr }}"

- name: Check for bluetooth pairing backup
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/files/bluetooth/{{ inventory_hostname }}"
  register: bluetooth_backup
  when: restore_bluetooth_backup | default(restore_last_ssh | default(false)) | bool
  become: false

- name: Restore bluetooth pairing data
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/files/bluetooth/{{ inventory_hostname }}/"
    dest: /var/lib/bluetooth/
    owner: root
    group: root
    mode: preserve
  when:
    - restore_bluetooth_backup | default(restore_last_ssh | default(false)) | bool
    - bluetooth_backup is defined
    - bluetooth_backup.stat.exists
  notify: Restart bluetooth service
  become: true

- name: Enable and start bluetooth service
  ansible.builtin.systemd:
    name: bluetooth
    state: started
    enabled: true
  changed_when: false

- name: Enable PipeWire user services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
    scope: user
  loop: "{{ pipewire_user_services }}"
  when: pipewire_user_services | length > 0
  become: false

- name: Create bluetooth reconnect script
  ansible.builtin.copy:
    dest: /usr/local/bin/bluetooth-reconnect.sh
    mode: '0755'
    content: |
      #!/usr/bin/env bash
      {% for mac in bluetooth_macs | default([]) %}
      bluetoothctl connect {{ mac }}
      {% endfor %}

- name: Ensure systemd user unit directory exists
  ansible.builtin.file:
    path: ~/.config/systemd/user
    state: directory
    mode: '0755'
  become: false

- name: Create systemd user service for reconnect
  ansible.builtin.copy:
    dest: ~/.config/systemd/user/bluetooth-reconnect.service
    mode: '0644'
    content: |
      [Unit]
      Description=Auto-connect Bluetooth devices

      [Service]
      ExecStart=/usr/local/bin/bluetooth-reconnect.sh

      [Install]
      WantedBy=default.target
  become: false

- name: Enable bluetooth reconnect service
  ansible.builtin.systemd:
    name: bluetooth-reconnect.service
    scope: user
    enabled: true
    state: started
  changed_when: false
  become: false
