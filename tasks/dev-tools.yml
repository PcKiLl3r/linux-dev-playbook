---
- name: Install Development Tools
  ansible.builtin.package:
    name: "{{ dev_tools_packages }}"
    state: present
    use: "{{ pkg_mgr }}"

- name: Verify Docker installation
  ansible.builtin.command: docker --version
  register: docker_check
  changed_when: false
  failed_when: docker_check.rc != 0

- name: Ensure Group "docker" Exists with correct gid
  ansible.builtin.group:
    name: docker
    state: present
  become: false

- name: Add User to "docker" Group
  ansible.builtin.user:
    name: "{{ username }}"
    groups: docker
    append: true

- name: Add username to git Config
  community.general.git_config:
    name: user.name
    scope: global
    value: "{{ username }}"
  become: false

- name: Add email to git Config
  community.general.git_config:
    name: user.email
    scope: global
    value: "{{ email }}"
  become: false

- name: Validate GitHub CLI token is available when authentication is enabled
  ansible.builtin.assert:
    that:
      - github_cli_token is defined
      - github_cli_token | length > 0
    fail_msg: "Set github_cli_token in vault/dev-tools.yml when github_cli_enable_auth is true."
  when: (github_cli_enable_auth | default(false)) | bool

- name: Check GitHub CLI authentication status
  ansible.builtin.command:
    argv:
      - gh
      - auth
      - status
  register: github_cli_auth_status
  changed_when: false
  failed_when: false
  become: true
  become_user: "{{ username }}"
  when: (github_cli_enable_auth | default(false)) | bool

- name: Authenticate GitHub CLI with stored token
  ansible.builtin.command:
    argv:
      - gh
      - auth
      - login
      - "--hostname"
      - "{{ github_cli_host | default('github.com') }}"
      - "--with-token"
    stdin: "{{ github_cli_token }}"
  register: github_cli_login
  changed_when: github_cli_login.rc == 0
  failed_when: github_cli_login.rc != 0
  no_log: true
  become: true
  become_user: "{{ username }}"
  when:
    - (github_cli_enable_auth | default(false)) | bool
    - (github_cli_token | default('')) | length > 0
    - github_cli_auth_status.rc != 0

