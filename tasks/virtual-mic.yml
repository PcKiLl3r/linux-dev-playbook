---
- name: Install virtual microphone support packages
  ansible.builtin.package:
    name: "{{ virtual_mic_packages }}"
    state: present
    use: "{{ pkg_mgr }}"
  when: virtual_mic_packages | length > 0

- name: Ensure PipeWire Pulse configuration directory exists for virtual mic
  ansible.builtin.file:
    path: "{{ home }}/.config/pipewire/pipewire-pulse.conf.d"
    state: directory
    mode: '0755'
  become: true
  become_user: "{{ username }}"

- name: Configure VirtualSink and VirtualMic modules
  ansible.builtin.copy:
    dest: "{{ home }}/.config/pipewire/pipewire-pulse.conf.d/virtual-mic.conf"
    mode: '0644'
    content: |
      # Generated by Ansible - creates a virtual sink and mirrored microphone
      pulse.cmd = [
        { cmd = load-module
          args = "module-null-sink sink_name=VirtualSink sink_properties='device.description=VirtualSink'"
        }
        { cmd = load-module
          args = "module-remap-source source_name=VirtualMic master=VirtualSink.monitor source_properties='device.description=VirtualMic'"
        }
      ]
  become: true
  become_user: "{{ username }}"
